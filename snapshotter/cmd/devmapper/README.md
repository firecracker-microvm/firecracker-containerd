# devmapper snapshotter for containerd and Firecracker

This component is a
[snapshotter](https://github.com/containerd/containerd/blob/master/design/snapshots.md)
[plugin](https://github.com/containerd/containerd/blob/master/PLUGINS.md) for
containerd that stores snapshots in ext4-formatted filesystem images in a
devicemapper thin pool.  The snapshots created by this snapshotter are usable
with the containerd-firecracker-runtime to run microVM-backed containers with
the Firecracker VMM.

## Installation

To make containerd aware of this plugin, you need to register it in
containerd's configuration file.  This file is typically located at
`/etc/containerd/config.toml`.

Here's a sample entry that can be made in the configuration file:

```toml
[proxy_plugins]
  [proxy_plugins.firecracker-dm-snapshotter]
    type = "snapshot"
    address = "/var/run/firecracker-dm-snapshotter.sock"
```

The name of the plugin in this example is "firecracker-dm-snapshotter".  The
`address` entry points to a socket file exposed by the snapshotter, which is
determined when you run it.

## Usage

```
./devmapper_snapshotter -address UNIX-DOMAIN-SOCKET -config CONFIG -debug
```

To run the snapshotter, you must specify the path to a Unix domain socket and a
path to a JSON configuration file.  The config file must contain the following
fields:

* `RootPath` - a directory where the metadata will be available
* `PoolName` - a name to use for the devicemapper thin pool
* `DataDevice` - path to the data volume that should be used by the thin pool
* `MetadataDevice` - path to the metadata volume that should be used by the thin
  pool
* `DataBlockSize` - the size of allocation chunks in data file, between 128
  sectors (64KB) and and 2097152 sectors (1GB) and a multiple of 128 sectors
  (64KB)
* `BaseImageSize` - defines how much space to allocate when creating the base
  device

Here's a sample entry that can be made in the configuration file `/etc/firecracker-dm-snapshotter/config.json`:
```json
{
	"base_image_size" : "20GB",
	"root_path" : "/tmp/test",
	"pool_name" : "test"
}
```

For example, to run the snapshotter with its domain socket at
`/var/run/firecracker-dm-snapshotter.sock` and its configuration file at
`/etc/firecracker-dm-snapshotter/config.json` you would run the snapshotter
plugin process as follows:

```
./devmapper_snapshotter -address /var/run/firecracker-dm-snapshotter.sock -config /etc/firecracker-dm-snapshotter/config.json
```

Now you can use snapshotter with containerd:

```
CONTAINERD_SNAPSHOTTER=firecracker-dm-snapshotter ctr images pull docker.io/library/alpine:latest
```

## Using container storage setup tool

The device mapper snapshotter is compatible with `container_storage_setup` [utility](https://github.com/projectatomic/container-storage-setup)
(formerly known as `docker-storage-setup`). `container-storage-setup` is a script to
configure COW file systems like devicemapper and overlayfs. It is usually run via a systemd service.

The snapshotter supports a subset of `dm.*` command line flags generated by `container_storage_setup`.

Here is a quick tutorial how it can be used togather.

- Run an EC2 instance with additional EBS volume `/dev/sdb` (this example uses CentOS 7)
- Install container storage setup tool

  ```bash
  $ yum update -y
  $ yum install -y container-storage-setup
  ```

- Create thin-pool device using `container-storage-setup` tool

  ```bash
  $ touch /etc/sysconfig/docker-storage-setup
  $ echo DEVS=/dev/xvdb >> /etc/sysconfig/docker-storage-setup
  $ echo VG=test >> /etc/sysconfig/docker-storage-setup
  $ container-storage-setup
  INFO: Volume group backing root filesystem could not be determined
  INFO: Writing zeros to first 4MB of device /dev/xvdb
  4+0 records in
  4+0 records out
  4194304 bytes (4.2 MB) copied, 0.0162157 s, 259 MB/s
  INFO: Device node /dev/xvdb1 exists.
    Physical volume "/dev/xvdb1" successfully created.
    Volume group "test" successfully created
    Rounding up size to full physical extent 20.00 MiB
    Thin pool volume with chunk size 512.00 KiB can address at most 126.50 TiB of data.
    Logical volume "docker-pool" created.
    Logical volume test/docker-pool changed.
  ```

  Run `man container-storage-setup` to get more information how to setup storage for container runtimes.

- `container-storage-setup` creates a runtime storage file which looks as follows:

  ```bash
  $ cat /etc/sysconfig/docker-storage
  DOCKER_STORAGE_OPTIONS="--storage-driver devicemapper --storage-opt dm.fs=xfs --storage-opt dm.thinpooldev=/dev/mapper/test-docker--pool "
  ```

- Now you can create a service script to run the device mapper snapshotter

  ```
  EnvironmentFile=/etc/sysconfig/docker-storage
  ...
  ExecStart=./devmapper_snapshotter -address /var/run/firecracker-dm-snapshotter.sock -debug $DOCKER_STORAGE_OPTIONS
  ...
  ```

  The output should look like:
  ```
  INFO[0000] loaded configuration file "/etc/containerd/devmapper-snapshotter.json"
  INFO[0000] applying storage opt: dm.fs=xfs
  WARN[0000] "xfs" not supported, defaulting to ext4
  INFO[0000] applying storage opt: dm.thinpooldev=/dev/mapper/test-docker--pool
  INFO[0000] initializing pool device "test-docker--pool"
  INFO[0000] using dmsetup:
  Library version:   1.02.110 (2015-10-30)
  Driver version:    4.37.0
  INFO[0000] running gRPC server                           unix_addr=/var/run/firecracker-dm-snapshotter.sock
  ```
